<!--jhScene.html >>>>>>>>>>>>> -->
<script type="text/html" id="jh-scene">
<div class="jh-scene">
<v-row class="ma-0 ml-xs-n1">
  <v-btn small outlined
         :class="{'jh-btn--active': selectedScene === index}"
         v-for="(scene, index) in sceneList"
         :key="index"
         @click="doUiAction('useScene', scene)"
         color="grey lighten-1" class="mb-2 ml-1">
    {{ scene.name }}
  </v-btn>
  <v-menu offset-y v-if="!fixed">
    <template v-slot:activator="{ on, attrs }">
      <v-btn
          v-bind="attrs"
          v-on="on"
          small outlined
          color="grey lighten-1"
          class="mb-2 ml-1 pa-1"
      >
        <v-icon right small class="mx-0">mdi-chevron-down</v-icon>
      </v-btn>
    </template>
    <v-list dense class="pb-0">
      <v-list-item @click="doUiAction('openCreateSceneDialog')">
        <v-list-item-title class="success--text">
          <v-icon small class="success--text">mdi-plus</v-icon>
          <span class="success--text">新建场景</span>
        </v-list-item-title>
      </v-list-item>
      <v-list-item @click="doUiAction('openSceneListDialog')">
        <v-list-item-title class="success--text">
          <v-icon small class="success--text">mdi-cog-outline</v-icon>
          <span class="success--text">场景管理</span>
        </v-list-item-title>
      </v-list-item>
    </v-list>
  </v-menu>
</v-row>

<!-- 新建场景 -->
<v-dialog
    v-if="!fixed"
    v-model="isAddSceneShown"
    persistent
    width="360px"
>
  <v-card>
    <v-card-title>
      <div class="d-flex justify-space-between align-center" style="width: 100%;">
        <div style="font-size: 16px;">新建场景</div>
        <div>
          <v-btn class="elevation-0" fab x-small @click="doUiAction('closeCreateSceneDialog')">
            <v-icon dark>mdi-close</v-icon>
          </v-btn>
        </div>
      </div>
    </v-card-title>
    <v-card-text>
      <v-container class="px-0">
        <div class="mb-4">
          <div class="mb-1">场景名称</div>
          <v-row>
            <v-col sm="12" md="12" xl="12">
              <v-text-field class="jh-v-input" :rules="validationRules.requireRules" dense filled single-line hide-details v-model="createItem.name" placeholder="场景名称，最多10个字符"></v-text-field>
            </v-col>
          </v-row>
        </div>
        <div class="mb-4">
          <div>筛选条件</div>
          <slot name="form" :form="createItem.form">
            <div>未配置form slot</div>
          </slot>
        </div>
        <v-row class="justify-end mx-0 mt-8">
          <v-btn color="success" @click="doUiAction('doCreateScene')" small>保存</v-btn>
          <v-btn class="ml-2" @click="doUiAction('closeCreateSceneDialog')" small>取消</v-btn>
        </v-row>
      </v-container>
    </v-card-text>
  </v-card>
</v-dialog>


<!-- 场景设置 -->
<v-dialog
    v-model="isSceneManageShown"
    persistent
    width="360px"
>
  <v-card class="scene-manage">
    <v-card-title>
      <div class="d-flex justify-space-between align-center" style="width: 100%;">
        <div style="font-size: 16px;">场景管理</div>
        <div>
          <v-btn class="elevation-0" fab x-small @click="doUiAction('closeSceneListDialog')">
            <v-icon dark>mdi-close</v-icon>
          </v-btn>
        </div>
      </div>
    </v-card-title>
    <v-card-text>
      <v-container class="px-0">
        <!-- <div class="mb-2">您可通过拖拽管理场景</div> -->
        <v-row justify="space-between" align="center">
          <v-col cols="12" xs="12" sm="12" md="12" xl="12" >
            <v-card outlined>
              <v-list dense class="scene-list">
                <template v-if="sceneCustomList && sceneCustomList.length">
                  <v-list-item class="scene-item px-2" v-for="(item, index) in sceneCustomList" :key="item.value" style="min-height: auto;">
                    <v-list-item-content>
                      {{item.name}}
                    </v-list-item-content>
                    <v-list-item-icon @click.stop="doUiAction('doDeleteScene', item)">
                      <v-icon size="22">mdi-delete</v-icon>
                    </v-list-item-icon>
                  </v-list-item>
                </template>
                <template v-else>
                  <div class="text-center grey--text" style="line-height: 100px;">暂无自定义场景</div>
                </template>
              </v-list>
            </v-card>
          </v-col>

        </v-row>
        <v-row class="justify-end mx-0 mt-8">
          <v-btn class="ml-2" @click="doUiAction('changeToCreateDialog')" small  color="success">新建场景</v-btn>
          <v-btn class="ml-2" @click="doUiAction('closeSceneListDialog')" small>取消</v-btn>
        </v-row>
      </v-container>
    </v-card-text>
  </v-card>
</v-dialog>
</div>
</script>

<script>
Vue.component('jh-scene', {
  template: "#jh-scene",
  vueComponent: 'jh-scene',
  vuetify: new Vuetify(),
  props: {
    initFormData: {
      type: Object,
      default: function () {
        return {};
      }
    },
    pageId: {
      type: String,
      default: location.href.split('/').pop()
    },
    currentSceneId: {
      type: String,
      default: null
    }
  },
  data() {
    return {
      isMobile: window.innerWidth < 500,
      validationRules: {
        requireRules: [
          v => !!v || 'This is required',
        ],
      },

      // 列表
      sceneList: [],
      // 自定义场景
      sceneCustomList: [],
      selectedScene: -1,
      // 新建场景
      isAddSceneShown: false,
      deleteItem: {
        form: {}
      },
      createItem: {
        form: {}
      },

      // 场景管理
      isSceneManageShown: false,
    };
  },
  computed: {
    sceneKey() {
      return this.pageId + '_' + window.userInfo.userId;
    },
    fixed() {
      return this.pageId === 'sceneSearchFixed';
    }
  },
  watch: {
    currentSceneId(newId, oldId) {
      if(newId != null) {
        this.selectedScene = this.sceneList.findIndex(item => item.id === newId);
      } else {
        this.selectedScene = null;
      }
    }
  },
  created() {
    this.doUiAction('getSceneList');
  },
  methods: {
    async doUiAction(uiActionId, uiActionData) {
      switch (uiActionId) {
        case 'getSceneList':
          await this.getSceneList();
          await this.useDefaultScene();
          break;
        case 'useScene':
          await this.useScene(uiActionData);
          break;
        case 'changeToCreateDialog':
          await this.closeSceneListDialog();
          await this.prepareCreateSceneData();
          await this.openCreateSceneDialog();
          break;
        case 'openCreateSceneDialog':
          await this.prepareCreateSceneData();
          await this.openCreateSceneDialog();
          break;
        case 'doCreateScene':
          await this.prepareValidate();
          await this.doCreateScene();
          await this.closeCreateSceneDialog();
          await this.getSceneList();
          await this.userNewCreateScene();
          break;
        case 'closeCreateSceneDialog':
          await this.closeCreateSceneDialog();
          break;
        case 'openSceneListDialog':
          await this.openSceneListDialog();
          break;
        case 'closeSceneListDialog':
          await this.closeSceneListDialog();
          break;
        case 'doDeleteScene':
          await this.prepareDeleteItemData(uiActionData);
          await this.checkCurrentScene();
          await this.doDeleteScene();
          await this.getSceneList();
          break;
        default:
          console.error("[doUiAction] uiActionId not find", {uiActionId});
          break;
      }
    },

    /**
     * 获取UUID
     * @returns {string}
     */
    getUUID(prefix) {
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 10; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[14] = "4"; // bits 12-15 of the time_hi_and_version field to 0010
      s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1); // bits 6-7 of the clock_seq_hi_and_reserved to 01
      var uuid = s.join("");
      return prefix + '-' + uuid;
    },

    // 场景列表
    async getSceneList() {
      let sceneData = JSON.parse(localStorage.getItem('sceneData') || '{}');
      this.sceneList = sceneData[this.sceneKey] || [];
      this.sceneCustomList = this.sceneList.filter(item => !item.system);
    },

    // 使用默认场景
    async useDefaultScene() {
      let defaultScene = this.sceneList.find(item => item.default === true);
      if (defaultScene) {
        this.selectedScene = this.sceneList.findIndex(item => item.default === true);
        this.useScene(defaultScene);
      }
    },

    // 使用场景
    async useScene(scene) {
      this.$emit('useScene', scene);
    },

    // =================================添加场景 start ======================================
    // 准备添加场景数据
    async prepareCreateSceneData() {
      this.createItem = {
        form: _.cloneDeep(this.initFormData),
        id: this.getUUID('scene')
      };
    },

    // 打开场景添加弹框
    async openCreateSceneDialog() {
      this.isAddSceneShown = true;
    },

    // 验证新场景名称
    prepareValidate() {
      const newSceneName = this.createItem.name;
      const nameExist = this.sceneList.some(item => item.name === newSceneName);
      if(nameExist) {
        window.vtoast.fail({message: '场景名称重复了'})
        throw new Error("场景名称重复")
      }
    },

    // 添加场景
    async doCreateScene() {
      let sceneData = JSON.parse(localStorage.getItem('sceneData') || '{}');
      let sceneList = sceneData[this.sceneKey] || [];
      const newScene = {...this.createItem};
      sceneList.push(newScene);
      sceneData[this.sceneKey] = sceneList;
      localStorage.setItem('sceneData', JSON.stringify(sceneData));
    },

    async userNewCreateScene() {
      const currentScene = this.sceneList.find(item => item.id === this.createItem.id);
      this.doUiAction('useScene', currentScene);
    },

    // 关闭场景添加弹框
    async closeCreateSceneDialog() {
      this.isAddSceneShown = false;
    },

    // =================================场景删除 >>>>>>>>>> ======================================
    // 准备场景管理数据
    async prepareDeleteItemData(item) {
      this.deleteItem = _.cloneDeep(item);
    },
    // 检查并重置当前选中scene
    async checkCurrentScene() {
      if(this.selectedScene === -1) {
        this.useDefaultScene();
        return;
      }
      const currentScene = this.sceneList[this.selectedScene];
      if(!currentScene) {
        this.useDefaultScene();
        return;
      }
      if(currentScene.id === this.deleteItem.id) {
        this.useDefaultScene();
      }
    },

    // 打开场景管理弹框
    async openSceneListDialog() {
      this.isSceneManageShown = true;
    },

    // 关闭场景管理弹框
    async closeSceneListDialog() {
      this.isSceneManageShown = false;
    },

    // 删除场景
    async doDeleteScene() {
      let sceneData = JSON.parse(localStorage.getItem('sceneData') || '{}');
      let sceneList = sceneData[this.sceneKey] || [];
      sceneData[this.sceneKey] = sceneList.filter(item => item.id !== this.deleteItem.id);
      localStorage.setItem('sceneData', JSON.stringify(sceneData));
    },
    // =================================场景管理 <<<<<<<<<<<< ======================================
  },
});

</script>
<style>
.jh-scene {
  display: inline-block;
}
.v-application--is-ltr .jh-scene .v-btn-toggle>.v-btn.v-btn {
  border-left-width: 1px!important;
  margin-left: 2px;
}
.scene-manage .scene-item:not(:last-child) {
  border-bottom: 1px solid #EEEEEE;
}


</style>
<!-- <<<<<<<<<<<<< jhScene.html -->
